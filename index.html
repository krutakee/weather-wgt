<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .weather-widget {
            display: flex;
            background: transparent;
            width: 100%;
            height: 117px;
            overflow: hidden;
        }

        .current-weather {
            background: #a4373a;
            color: white;
            padding: 10px;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 4px 0 0 4px;
        }

        .location-name {
            font-size: 12px;
            opacity: 0.95;
            text-align: center;
            margin-bottom: 0;
        }

        .current-temp-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto;
        }

        .current-icon {
            font-size: 36px;
            line-height: 1;
        }

        .current-temp {
            font-size: 36px;
            font-weight: 300;
            line-height: 1;
        }

        .temp-unit {
            font-size: 20px;
            font-weight: 300;
            vertical-align: top;
        }

        .current-condition {
            font-size: 12px;
            text-align: center;
            margin-top: 0;
        }

        .current-meta {
            gap: 10px;
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
            cursor: help;
            text-align: center;
        }

        .forecast-section {
            flex: 1;
            padding: 0 20px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0 4px 4px 0;
            overflow: hidden;
        }

        .forecast-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            overflow-y: hidden;
            width: 100%;
            padding: 0;
            justify-content: center;
        }

        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            border-right: 1px solid #e0e0e0;
            min-width: 90px;
            flex: 1;
            transition: background 0.2s ease;
        }

        .forecast-item:last-child {
            border-right: none;
        }

        .forecast-item:hover {
            background: #d8d8d8;
            border-radius: 4px;
        }

        .forecast-day {
            font-size: 12px;
            color: #323130;
        }

        .forecast-icon {
            font-size: 25px;
            margin: 0;
        }

        .forecast-description {
            font-size: 12px;
            color: #605e5c;
            text-align: center;
            text-transform: capitalize;
            margin: 0;
            min-height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forecast-temps {
            display: flex;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
            color: #323130;
            margin-top: 2px;
        }

        .temp-high {
            color: #323130;
        }

        .temp-low {
            color: #605e5c;
            font-weight: 400;
        }

        .temp-separator {
            color: #d2d0ce;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #605e5c;
            font-size: 12px;
            background: white;
            border-radius: 4px;
        }

        .error {
            padding: 15px;
            background: #fef0f1;
            color: #a4373a;
            border-left: 4px solid #a4373a;
            margin: 10px;
            font-size: 11px;
            line-height: 1.6;
            border-radius: 4px;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .forecast-list::-webkit-scrollbar {
            height: 4px;
        }

        .forecast-list::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 2px;
        }

        .forecast-list::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 2px;
        }

        .forecast-list::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        @media (max-width: 768px) {
            .weather-widget {
                flex-direction: column;
                height: auto;
            }

            .current-weather {
                min-width: 100%;
                border-radius: 4px 4px 0 0;
            }

            .forecast-section {
                padding: 10px;
                border-radius: 0 0 4px 4px;
            }

            .forecast-item {
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="weather-widget" id="weatherWidget">
        <div class="loading">Loading weather data...</div>
    </div>

    <script>
        const API_KEY = 'd1ecc9501979b4fde5c87fff251e25d2';
        const CACHE_DURATION = 15 * 60 * 1000; // 15 minutes
        
        const weatherIcons = {
            'Clear': '‚òÄÔ∏è', 'Clouds': '‚òÅÔ∏è', 'Rain': 'üåßÔ∏è', 'Drizzle': 'üå¶Ô∏è',
            'Thunderstorm': '‚õàÔ∏è', 'Snow': '‚ùÑÔ∏è', 'Mist': 'üå´Ô∏è', 'Smoke': 'üå´Ô∏è',
            'Haze': 'üå´Ô∏è', 'Dust': 'üå´Ô∏è', 'Fog': 'üå´Ô∏è', 'Sand': 'üå´Ô∏è',
            'Ash': 'üå´Ô∏è', 'Squall': 'üí®', 'Tornado': 'üå™Ô∏è'
        };

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                city: params.get('city') || 'Ronkonkoma',
                state: params.get('state') || 'NY',
                country: params.get('country') || 'US',
                zip: params.get('zip') || null,
                units: params.get('units') || 'imperial'
            };
        }

        const config = getUrlParams();

        function getCacheKey(type) {
            const location = config.zip || config.city;
            return `weather_cache_${type}_${location}`;
        }

        function getCachedData() {
            try {
                const timestamp = localStorage.getItem(getCacheKey('time'));
                const now = Date.now();
                
                if (timestamp && (now - parseInt(timestamp)) < CACHE_DURATION) {
                    const currentData = localStorage.getItem(getCacheKey('current'));
                    const forecastData = localStorage.getItem(getCacheKey('forecast'));
                    
                    if (currentData && forecastData) {
                        const age = Math.round((now - parseInt(timestamp)) / 1000);
                        console.log(`Using cached data (${age}s old)`);
                        return {
                            current: JSON.parse(currentData),
                            forecast: JSON.parse(forecastData),
                            cached: true,
                            age: age
                        };
                    }
                }
            } catch (error) {
                console.log('Cache read error:', error);
            }
            return null;
        }

        function setCachedData(currentData, forecastData) {
            try {
                localStorage.setItem(getCacheKey('current'), JSON.stringify(currentData));
                localStorage.setItem(getCacheKey('forecast'), JSON.stringify(forecastData));
                localStorage.setItem(getCacheKey('time'), Date.now().toString());
                console.log('Data cached for 15 minutes');
            } catch (error) {
                console.log('Cache write error:', error);
            }
        }

        async function fetchWeatherData(endpoint) {
            const baseUrl = 'https://api.openweathermap.org/data/2.5/';
            const apiUrls = [];
            
            if (config.zip) {
                apiUrls.push(`${baseUrl}${endpoint}?zip=${config.zip},${config.country}&appid=${API_KEY}&units=${config.units}`);
            }
            
            apiUrls.push(
                `${baseUrl}${endpoint}?q=${config.city},${config.state},${config.country}&appid=${API_KEY}&units=${config.units}`,
                `${baseUrl}${endpoint}?q=${config.city},${config.country}&appid=${API_KEY}&units=${config.units}`,
                `${baseUrl}${endpoint}?q=${config.city}&appid=${API_KEY}&units=${config.units}`
            );

            for (const url of apiUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) return await response.json();
                } catch (error) {
                    console.log('Fetch attempt failed:', error);
                }
            }
            throw new Error(`Unable to fetch ${endpoint} data`);
        }

        function processForecastData(data) {
            const dailyForecasts = {};
            
            data.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dateKey = date.toDateString();
                
                if (!dailyForecasts[dateKey]) {
                    dailyForecasts[dateKey] = {
                        date: date,
                        temps: [],
                        conditions: [],
                        item: item
                    };
                }
                
                dailyForecasts[dateKey].temps.push(item.main.temp);
                dailyForecasts[dateKey].conditions.push(item.weather[0].main);
            });

            return Object.values(dailyForecasts).slice(1, 6).map(day => ({
                date: day.date,
                tempHigh: Math.round(Math.max(...day.temps)),
                tempLow: Math.round(Math.min(...day.temps)),
                condition: day.conditions[0],
                description: day.item.weather[0].description,
                icon: weatherIcons[day.conditions[0]] || 'üå°Ô∏è'
            }));
        }

        function displayWeather(currentData, forecastData, isCached = false, cacheAge = 0) {
            const widget = document.getElementById('weatherWidget');
            const tempUnit = config.units === 'metric' ? 'C' : 'F';
            
            const current = {
                location: `${currentData.name}, ${config.state}`,
                temp: Math.round(currentData.main.temp),
                description: currentData.weather[0].description,
                high: Math.round(currentData.main.temp_max),
                low: Math.round(currentData.main.temp_min),
                icon: weatherIcons[currentData.weather[0].main] || 'üå°Ô∏è',
                date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            };

            const forecastHTML = forecastData.map(day => {
                const dayName = day.date.toLocaleDateString('en-US', { weekday: 'short' });
                return `
                    <div class="forecast-item">
                        <div class="forecast-day">
                            ${dayName}                             
                        </div>
                        <div class="forecast-icon">${day.icon}</div>
                        <div class="forecast-temps">
                            <span class="temp-high">${day.tempHigh}¬∞</span>
                            <span class="temp-separator">/</span>
                            <span class="temp-low">${day.tempLow}¬∞</span>
                        </div>
                        <div class="forecast-description">${day.description}</div>
                    </div>
                `;
            }).join('');

            const tooltipText = isCached ? `Cached data from ${cacheAge} seconds ago` : 'Live data';

            widget.innerHTML = `
                <div class="current-weather">
                    <div class="location-name">${current.location} <!--${current.date}--></div>              
                    <div class="current-temp-container">
                        <div class="current-icon">${current.icon}</div>
                        <div>
                            <span class="current-temp">${current.temp}</span><span class="temp-unit">¬∞${tempUnit}</span>
                        </div>
                    </div>
                    <div class="current-meta" title="${tooltipText}">
                        ${current.high}¬∞/${current.low}¬∞
                    </div>                
                    <div class="current-condition">${current.description.charAt(0).toUpperCase() + current.description.slice(1)}</div>
                </div>
                <div class="forecast-section">
                    <div class="forecast-list">
                        ${forecastHTML}
                    </div>
                </div>
            `;
        }

        function displayError(message) {
            const widget = document.getElementById('weatherWidget');
            widget.innerHTML = `
                <div class="error">
                    <div class="error-title">Unable to load weather data</div>
                    <div>${message}</div>
                    <div style="margin-top: 8px; font-size: 10px;">
                        ‚Ä¢ Check API key is correct and active<br>
                        ‚Ä¢ New keys may take 10 minutes to activate<br>
                        ‚Ä¢ Location: ${config.zip || `${config.city}, ${config.state}`}
                    </div>
                </div>
            `;
        }

        async function init() {
            try {
                if (API_KEY === 'YOUR_API_KEY_HERE') {
                    displayError('Please add your OpenWeatherMap API key');
                    return;
                }

                const cachedData = getCachedData();
                if (cachedData) {
                    const forecastData = processForecastData(cachedData.forecast);
                    displayWeather(cachedData.current, forecastData, true, cachedData.age);
                    return;
                }

                console.log('Fetching fresh weather data...');
                
                const [currentData, forecastDataRaw] = await Promise.all([
                    fetchWeatherData('weather'),
                    fetchWeatherData('forecast')
                ]);

                setCachedData(currentData, forecastDataRaw);

                const forecastData = processForecastData(forecastDataRaw);
                displayWeather(currentData, forecastData, false, 0);
                
                console.log('Weather data loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            }
        }

        init();
        setInterval(init, 30 * 60 * 1000); // Refresh every 30 minutes
    </script>
</body>
</html>
