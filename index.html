<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            padding: 0;
            margin: 0;
        }

        .weather-widget {
            display: flex;
            background: transparent;
            max-width: 100%;
            margin: 0;
        }

        .current-weather {
            background: #a4373a;
            color: white;
            padding: 30px 40px;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 4px 0 0 4px;
        }

        .location-name {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .current-temp-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .current-icon {
            font-size: 56px;
            line-height: 1;
        }

        .current-temp {
            font-size: 64px;
            font-weight: 300;
            line-height: 1;
        }

        .temp-unit {
            font-size: 28px;
            font-weight: 300;
            vertical-align: top;
        }

        .current-condition {
            font-size: 15px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .current-range {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .current-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            opacity: 0.85;
            margin-top: 10px;
        }

        .forecast-section {
            flex: 1;
            padding: 20px 30px;
            background: white;
            display: flex;
            flex-direction: column;
            border-radius: 0 4px 4px 0;
        }

        .forecast-list {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 20px;
            border-right: 1px solid #edebe9;
            min-width: 120px;
            transition: background 0.2s ease;
            flex: 1;
        }

        .forecast-item:last-child {
            border-right: none;
        }

        .forecast-item:hover {
            background: #f9f9f9;
            border-radius: 4px;
        }

        .forecast-day {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 12px;
        }

        .forecast-icon {
            font-size: 36px;
            margin: 8px 0;
        }

        .forecast-description {
            font-size: 12px;
            color: #605e5c;
            text-align: center;
            text-transform: capitalize;
            margin: 8px 0;
            min-height: 32px;
            display: flex;
            align-items: center;
        }

        .forecast-temps {
            display: flex;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #323130;
            margin-top: 8px;
        }

        .temp-high {
            color: #323130;
        }

        .temp-low {
            color: #605e5c;
            font-weight: 400;
        }

        .temp-separator {
            color: #d2d0ce;
        }

        .loading {
            padding: 40px;
            text-align: center;
            color: #605e5c;
            font-size: 14px;
            background: white;
            border-radius: 4px;
        }

        .error {
            padding: 30px;
            background: #fef0f1;
            color: #a4373a;
            border-left: 4px solid #a4373a;
            margin: 20px;
            font-size: 14px;
            line-height: 1.6;
            border-radius: 4px;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .cache-indicator {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .forecast-list::-webkit-scrollbar {
            height: 6px;
        }

        .forecast-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .forecast-list::-webkit-scrollbar-thumb {
            background: #d2d0ce;
            border-radius: 3px;
        }

        .forecast-list::-webkit-scrollbar-thumb:hover {
            background: #a19f9d;
        }

        @media (max-width: 768px) {
            .weather-widget {
                flex-direction: column;
            }

            .current-weather {
                min-width: 100%;
                border-radius: 4px 4px 0 0;
            }

            .forecast-section {
                padding: 20px;
                border-radius: 0 0 4px 4px;
            }

            .forecast-item {
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="weather-widget" id="weatherWidget">
        <div class="loading">Loading weather data...</div>
    </div>

    <script>
        const API_KEY = 'd1ecc9501979b4fde5c87fff251e25d2';
        
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                city: params.get('city') || 'Ronkonkoma',
                state: params.get('state') || 'NY',
                country: params.get('country') || 'US',
                zip: params.get('zip') || null,
                units: params.get('units') || 'imperial'
            };
        }

        const config = getUrlParams();
        const UNITS = config.units;

        // Cache configuration
        const CACHE_KEY_CURRENT = 'weather_cache_current_' + (config.zip || config.city);
        const CACHE_KEY_FORECAST = 'weather_cache_forecast_' + (config.zip || config.city);
        const CACHE_KEY_TIMESTAMP = 'weather_cache_time_' + (config.zip || config.city);
        const CACHE_DURATION = 15 * 60 * 1000; // 15 minutes

        const weatherIcons = {
            'Clear': '‚òÄÔ∏è',
            'Clouds': '‚òÅÔ∏è',
            'Rain': 'üåßÔ∏è',
            'Drizzle': 'üå¶Ô∏è',
            'Thunderstorm': '‚õàÔ∏è',
            'Snow': '‚ùÑÔ∏è',
            'Mist': 'üå´Ô∏è',
            'Smoke': 'üå´Ô∏è',
            'Haze': 'üå´Ô∏è',
            'Dust': 'üå´Ô∏è',
            'Fog': 'üå´Ô∏è',
            'Sand': 'üå´Ô∏è',
            'Ash': 'üå´Ô∏è',
            'Squall': 'üí®',
            'Tornado': 'üå™Ô∏è'
        };

        function getCachedData() {
            try {
                const timestamp = localStorage.getItem(CACHE_KEY_TIMESTAMP);
                const now = Date.now();
                
                if (timestamp && (now - parseInt(timestamp)) < CACHE_DURATION) {
                    const currentData = localStorage.getItem(CACHE_KEY_CURRENT);
                    const forecastData = localStorage.getItem(CACHE_KEY_FORECAST);
                    
                    if (currentData && forecastData) {
                        const age = Math.round((now - parseInt(timestamp)) / 1000);
                        console.log(`Using cached data (${age}s old)`);
                        return {
                            current: JSON.parse(currentData),
                            forecast: JSON.parse(forecastData),
                            cached: true,
                            age: age
                        };
                    }
                }
            } catch (error) {
                console.log('Cache read error:', error);
            }
            return null;
        }

        function setCachedData(currentData, forecastData) {
            try {
                localStorage.setItem(CACHE_KEY_CURRENT, JSON.stringify(currentData));
                localStorage.setItem(CACHE_KEY_FORECAST, JSON.stringify(forecastData));
                localStorage.setItem(CACHE_KEY_TIMESTAMP, Date.now().toString());
                console.log('Weather data cached for 5 minutes');
            } catch (error) {
                console.log('Cache write error:', error);
            }
        }

        async function fetchCurrentWeather() {
            const apiUrls = [];
            
            if (config.zip) {
                apiUrls.push(
                    `https://api.openweathermap.org/data/2.5/weather?zip=${config.zip},${config.country}&appid=${API_KEY}&units=${UNITS}`
                );
            }
            
            apiUrls.push(
                `https://api.openweathermap.org/data/2.5/weather?q=${config.city},${config.state},${config.country}&appid=${API_KEY}&units=${UNITS}`,
                `https://api.openweathermap.org/data/2.5/weather?q=${config.city},${config.country}&appid=${API_KEY}&units=${UNITS}`,
                `https://api.openweathermap.org/data/2.5/weather?q=${config.city}&appid=${API_KEY}&units=${UNITS}`
            );

            for (const url of apiUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.log('Fetch attempt failed:', error);
                }
            }
            throw new Error('Unable to fetch current weather');
        }

        async function fetchForecastWeather() {
            const apiUrls = [];
            
            if (config.zip) {
                apiUrls.push(
                    `https://api.openweathermap.org/data/2.5/forecast?zip=${config.zip},${config.country}&appid=${API_KEY}&units=${UNITS}`
                );
            }
            
            apiUrls.push(
                `https://api.openweathermap.org/data/2.5/forecast?q=${config.city},${config.state},${config.country}&appid=${API_KEY}&units=${UNITS}`,
                `https://api.openweathermap.org/data/2.5/forecast?q=${config.city},${config.country}&appid=${API_KEY}&units=${UNITS}`,
                `https://api.openweathermap.org/data/2.5/forecast?q=${config.city}&appid=${API_KEY}&units=${UNITS}`
            );

            for (const url of apiUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.log('Forecast fetch failed:', error);
                }
            }
            throw new Error('Unable to fetch forecast');
        }

        function processForecastData(data) {
            const dailyForecasts = {};
            
            data.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dateKey = date.toDateString();
                
                if (!dailyForecasts[dateKey]) {
                    dailyForecasts[dateKey] = {
                        date: date,
                        temps: [],
                        conditions: [],
                        item: item
                    };
                }
                
                dailyForecasts[dateKey].temps.push(item.main.temp);
                dailyForecasts[dateKey].conditions.push(item.weather[0].main);
            });

            const days = Object.values(dailyForecasts).slice(1, 6);
            
            return days.map(day => ({
                date: day.date,
                tempHigh: Math.round(Math.max(...day.temps)),
                tempLow: Math.round(Math.min(...day.temps)),
                condition: day.conditions[0],
                description: day.item.weather[0].description,
                icon: weatherIcons[day.conditions[0]] || 'üå°Ô∏è'
            }));
        }

        function displayWeather(currentData, forecastData, isCached = false, cacheAge = 0) {
            const widget = document.getElementById('weatherWidget');
            const degreeSymbol = '¬∞';
            const tempUnitDisplay = UNITS === 'metric' ? 'C' : 'F';
            
            const current = {
                location: `${currentData.name}, ${currentData.sys.country}`,
                temp: Math.round(currentData.main.temp),
                condition: currentData.weather[0].main,
                description: currentData.weather[0].description,
                high: Math.round(currentData.main.temp_max),
                low: Math.round(currentData.main.temp_min),
                icon: weatherIcons[currentData.weather[0].main] || 'üå°Ô∏è',
                date: new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })
            };

            const forecastHTML = forecastData.map(day => {
                const dayName = day.date.toLocaleDateString('en-US', { weekday: 'short' });
                
                return `
                    <div class="forecast-item">
                        <div class="forecast-day">${dayName}</div>
                        <div class="forecast-icon">${day.icon}</div>
                        <div class="forecast-description">${day.description}</div>
                        <div class="forecast-temps">
                            <span class="temp-high">${day.tempHigh}${degreeSymbol}</span>
                            <span class="temp-separator">/</span>
                            <span class="temp-low">${day.tempLow}${degreeSymbol}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const cacheIndicator = isCached ? 
                `<div class="cache-indicator">üì¶ Cached (${cacheAge}s ago)</div>` : '';

            widget.innerHTML = `
                <div class="current-weather">
                    <div class="location-name">${current.location}</div>
                    <div class="current-temp-container">
                        <div class="current-icon">${current.icon}</div>
                        <div>
                            <span class="current-temp">${current.temp}</span><span class="temp-unit">${degreeSymbol}${tempUnitDisplay}</span>
                        </div>
                    </div>
                    <div class="current-condition">${current.description.charAt(0).toUpperCase() + current.description.slice(1)}</div>
                    <div class="current-range">${current.high}${degreeSymbol}/${current.low}${degreeSymbol}</div>
                    <div class="current-meta">
                        <span>${current.date}</span>
                    </div>
                    ${cacheIndicator}
                </div>
                <div class="forecast-section">
                    <div class="forecast-list">
                        ${forecastHTML}
                    </div>
                </div>
            `;
        }

        function displayError(message) {
            const widget = document.getElementById('weatherWidget');
            widget.innerHTML = `
                <div class="error">
                    <div class="error-title">Unable to load weather data</div>
                    <div>${message}</div>
                    <div style="margin-top: 12px; font-size: 13px;">
                        ‚Ä¢ Check your API key is correct and active<br>
                        ‚Ä¢ New API keys may take 10 minutes to activate<br>
                        ‚Ä¢ Location: ${config.zip || `${config.city}, ${config.state}`}<br>
                        ‚Ä¢ Open browser console (F12) for details
                    </div>
                </div>
            `;
        }

        async function init() {
            try {
                if (API_KEY === 'YOUR_API_KEY_HERE') {
                    displayError('Please add your OpenWeatherMap API key');
                    return;
                }

                // Try cache first
                const cachedData = getCachedData();
                if (cachedData) {
                    const forecastData = processForecastData(cachedData.forecast);
                    displayWeather(cachedData.current, forecastData, true, cachedData.age);
                    return;
                }

                console.log('Fetching fresh weather data...');
                
                const [currentData, forecastDataRaw] = await Promise.all([
                    fetchCurrentWeather(),
                    fetchForecastWeather()
                ]);

                setCachedData(currentData, forecastDataRaw);

                const forecastData = processForecastData(forecastDataRaw);
                displayWeather(currentData, forecastData, false, 0);
                
                console.log('Weather data loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            }
        }

        init();
        setInterval(init, 30 * 60 * 1000); // Refresh every 30 minutes
    </script>
</body>
</html>
